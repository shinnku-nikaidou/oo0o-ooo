---
layout: "@/partials/BasePost.astro"
title: "Online Matching with Stochastic Rewards"
description: "Online Matching with Stochastic Rewards"
pubDate: 2025-10-23T00:00:00Z
imgSrc: "/img/posts/bipartite.png"
imgAlt: "A bipartite graph representation"
---

## Setting & model

### Online Bipartite Matching

The author Karp, Vazirani, and Vazirani introduce a bipartite graph model $G =(U \cup V, E)$,
where $U$ is given offline and $V$ arrives online [KVV90].
The online algorithm must irrevocably match each arriving vertex $v \in V$ to an unmatched neighbor in $U$ or leave it unmatched.

The offline optimal is defined as the maximum matching in $G$.
The competitive ratio is defined as the expected size of the matching produced by the online algorithm divided by the size of the offline optimal matching.

$$
Ratio = ALG / OPT
$$

### Online Stochastic Matching Problem

In the online matching problem with stochastic rewards, every edge $(u, v)$ also has an associated probability of success $p_{uv}$.

When a new vertex $v \in V$ arrives online, the algorithm either chooses not to assign it at all, or assigns it to one of its neighbors (these are the available options).

If $v$ is assigned to $u \in U$ using the edge $(u, v)$, a Bernoulli experiment is performed and the edge $(u, v)$ becomes a successful assignment with probability $p_{uv}$.

In successful assignment case, we say that $u$ was successful and remove it from the set of _available_ vertices.
On the other hand, if the assignment $(u, v)$ is not successful, $u$ remains available and a neighbor of $u$ that arrives later in the online order can be assigned to $u$ (but $v$ cannot be assigned in the future).

The overall objective is to maximize the _expected_ number of successful vertices $u \in U$, or equivalently, the expected number of successful assignments.

### Vertex-Weighted Stochastic Matching

In the vertex-weighted variant, each offline vertex $u \in U$ has a nonnegative weight $w_u$.
A successful assignment on $u$ yields reward $w_u$ and removes $u$ from availability (as before).
The objective becomes maximizing the **expected total weight** of successful offline vertices:

$$
\max \; \mathbb{E}\!\left[\sum_{u \in U} w_u \cdot \mathbf{1}\{u\ \text{is matched successfully}\}\right].
$$

The unweighted model is the special case $w_u \equiv 1$.

The four probability regimes below (Vanishing/Arbitrary × Equal/Unequal) remain the same; results in recent work typically extend to the vertex-weighted case with essentially the same analyses.

### Probability Settings

1. Vanishing & Equal Probabilities
2. Vanishing & Unequal Probabilities
3. Arbitrary/Non-Vanishing & Equal Probabilities
4. Arbitrary/Non-Vanishing & Unequal

## Offline Optimal Benchmark

### The Budgeted Allocation Problem

Let $G = (U \cup V, E)$ be a bipartite graph where edge $(u, v)$ has weight
$p_{uv}$.
For every vertex $v \in V$, we assign it to one its neighbors $u \in U$ using
edge $(u, v)$.
The _load_ $L_u$ on a vertex $u \in U$ is defined as the sum of weights of
assigned edges incident on $u$.
The objective is to maximize $\sum_{u \in U} \min(L_u, 1)$.

For technical reasons, we allow fractional solutions, i.e. vertex $v \in V$
can be assigned to its neighbors $u \in U$ with fractions $x_{uv}$ subject to
$\sum_{u \in U} x_{uv} \le 1$; then $L_u = \sum_{u \in U} x_{uv} p_{uv}$.

For any instance of the **Online Stochastic Matching** problem, we define
$OPT$ to be the optimum fractional solution for the corresponding **Budgeted
Allocation** problem.
The next lemma claims that the value of $OPT$ is at least the expected number
of successes obtained by _any_ **Online Stochastic Matching** algorithm.

## Distribution of the Success Threshold (Ө)

Let $\tau$ be the round of the first success when repeatedly attempting the same offline vertex $u$. Then

$$
\tau \sim \operatorname{Geom}(p) \quad(\tau=1,2,3, \ldots) .
$$

Measure "load" as the cumulative success probability: each attempt adds $p$. Define

$$
\Theta:=p \cdot \tau .
$$

Hence,

$$
\operatorname{Pr}[\Theta=t p]=p(1-p)^{t-1} \quad(t=1,2, \ldots)
$$

so $\Theta$ only takes values in $\{p, 2 p, 3 p, \ldots\}$.
A vertex $u$ becomes successful the first time its accumulated load $\ell_u$
reaches or exceeds $\Theta$.
This is exactly the "equivalent threshold view" used by Mehta-Panigrahi.

Basic moments. $\mathbb{E}[\Theta]=1$ and $\operatorname{Var}(\Theta)=1-p$.
Thus, as $p \rightarrow 0$, both the mean and the variance tend to 1.

Vanishing limit $(p \rightarrow 0)$.
Viewing the discrete distribution as a continuous-load approximation,

$$
\operatorname{Pr}[\Theta>x]=(1-p)^{\lfloor x / p\rfloor} \underset{p \rightarrow 0}{\longrightarrow} e^{-x}
$$

i.e., $\Theta \Rightarrow \operatorname{Exp}(1)$.
Consequently, in small-$p$ analyses it is standard to model each offline
vertex's threshold as an independent $\operatorname{Exp}(1)$ random variable.

Unequal but small probabilities.
If the edge success probabilities $p_{u v}$ differ but are all small, we still
measure load as the sum of allocated success probabilities.
In this continuous-load coordinate, the threshold is well-approximated by
$\operatorname{Exp}(1)$; each attempt just increments the load by the
corresponding $p_{u v}$ instead of a fixed $p$.

## Definition of Competitive Ratio

Let $N_u$ denote the set of neighbors of an offline vertex $u$.

For the **unweighted** case, the competitive ratio is $\mathbb{E}[ALG]/OPT$.

For the **vertex-weighted** case, the competitive ratio is $\mathbb{E}[ALG_w]/OPT_w$.

A convenient upper bound/benchmark is the (configuration) LP relaxation; a simple edge-based LP that suffices for exposition is:

$$
\begin{aligned}
\max \quad & \sum_{u \in U} w_u\cdot p_{uv} \cdot x_{uv} \\
\text{s.t.}\quad
& \sum_{v \in N(u)} p_{uv}\, x_{uv} \;\le\; 1 \qquad && \forall u \in U && (1) \\
& \sum_{u \in N(v)} x_{uv} \;\le\; 1 \qquad && \forall v \in V && (2) \\
& 0 \le x_{uv}
\end{aligned}
$$

Here $x_{uv}$ is the (fractional) probability of attempting $(u,v)$, all
$w_u\equiv 1$ recovers the unweighted benchmark.

Eqn. (1) states that the expected load of each offline vertex $u$ is upper
bounded by 1, because it is upper bounded by the expectation of the threshold
$\theta_u$, which equals 1. (this uses the Law of Total Probability)

Eqn. (2) is a standard capacity constraint: each online vertex $v$ can be
matched to at most one offline neighbor.

Following the vertex-weighted model of Mehta and Panigrahi [24], we will
consider the optimal objective of the above LP relaxation as the benchmark.

**Configuration LP**

For any $S \subseteq N_u$, let $p_u(S)= \min \left\{\sum_{v \in S} p_{u v}, 1\right\}$.
Consider the following offline-side configuration LP:

$$
\begin{aligned}
\text{ConfigLP:} \quad \max \quad & \sum_{u \in U} \sum_{S \subseteq N_u} w_u \cdot p_u(S) \cdot x_{u S} \\
\text{s.t.} \quad & \sum_{S \subseteq N_u} x_{u S} \leq 1 && \forall u \in U \\
& \sum_{u \in U} \sum_{S \subseteq N_u: v \in S} x_{u S} \leq 1 && \forall v \in V \\
& x_{u S} \geq 0 && \forall u \in U, \forall S \subseteq N_u
\end{aligned}
$$

From an offline optimization viewpoint, as $p$, the upper bound of success
probabilities, tends to zero, the configuration LP is equivalent to the
standard matching LP in the following sense.
First, the matching LP can be reinterpreted as to maximize

$$
\sum_{u \in U} w_u \cdot \min \left\{\sum_{v:(u, v) \in E} p_{u v} x_{u v}, 1\right\}
$$

subject to only Eqn. (2) and (3).

On one hand, any feasible assignment of the configuration LP corresponds to a
feasible assignment of the matching LP with

$$
x_{u v}=\sum_{S \in N_u: v \in S} x_{u S}.
$$

Comparing the objectives of the LPs, the matching LP objective is weakly
larger because $\min \{z, 1\}$ is concave.

On the other hand, given any feasible assignment of the matching LP, we can
sample an integral matching via independent rounding, i.e., match each online
vertex $v$ to a neighbor that is independently sampled according to
$x_{u v}$ 's.

Then, it gives an integral assignment of the configuration LP: $x_{u S}=1$ for
the subset $S$ of neighbors matched to $u$ in the independent rounding, and 0
otherwise.
Further, by standard concentration inequalities (and union bound), the load of
each vertex $u$ is at most its expected load, which is at most 1 due to
Eqn. (1), plus an additive error that diminishes as $p$ tends to zero.
Hence, the optimal of the configuration LP is at least that of the matching LP
less a term that diminishes as $p$ tends to zero.

The corresponding dual LP of the configuration LP is the following:

$$
\begin{aligned}
\text{Dual:} \quad \min \quad & \sum_{u \in U} \alpha_u+\sum_{v \in V} \beta_v \\
\text{s.t.} \quad & \alpha_u+\sum_{v \in S} \beta_v \geq w_u \cdot p_u(S) && \forall u \in U, \forall S \subseteq N_u \\
& \alpha_u, \beta_v \geq 0 && \forall u \in U, \forall v \in V
\end{aligned}
$$

An algorithm is $\Gamma$-competitive if:

1. Equal primal and dual objectives:

$$
\sum_{u \in U} \sum_{S \subseteq N_u} p_u(S) \cdot w_u \cdot x_{u S}=\sum_{u \in U} \alpha_u+\sum_{v \in V} \beta_v ;
$$

Approximate dual feasibility: For any $u \in U$ and any $S \subseteq N_u$,

$$
\mathbf{E}\left[\alpha_u+\sum_{v \in S} \beta_v\right] \geq \Gamma \cdot w_u \cdot p_u(S)
$$

## Analyses

Let $\ell_u$ denotes the load of an offline vertex $u \in U$, $\Theta$ be the vector of $\Theta_u$ for all $u \in U$, and let $\Theta_{-u}$ denote the entire vector $\Theta$ except $\Theta_u$.
For any fixed ( $n-1$ )-dimensional vector $\theta$, let

$$
p_u(\theta):=\operatorname{Pr}\left[\Theta_{-u}=\theta\right]
$$

Further, let $\ell_u^{\infty}(\theta)$ be the load on vertex $u$ when $\Theta_{-u}=\theta$ and $\Theta_u=\infty$; correspondingly, let

$$
q_u(x):=\sum_{\substack{\theta: \ell_u^{\infty}(\theta)=x }} p_u(\theta)
$$

### Dual Assignment

Note that $u$ 's load increases over time; let it be the current load in the following discussion.
For some **non-decreasing function** $f: \mathbf{R}^{+} \mapsto \mathbf{R}^{+}$to be determined in the analysis, we maintain the dual assignment as follows.

1. Initially, let $\alpha_u=0$ for all $u \in U$.
2. On the arrival of an online vertex $v \in V$ and, thus, the corresponding dual variable $\beta_v$ :
   (a) If $v$ is matched to $u \in U$, increase $\alpha_u$ by $p f\left(\ell_u\right)$ and let $\beta_v=p\left(1-f\left(\ell_u\right)\right)$.
   (b) If $v$ has no unsuccessful neighbor, let $\beta_v=0$.

Let $F(\ell)=\int_0^{\ell} f(z) d z$ denote the integral of $f$. Note that we have $\alpha_u=F\left(\ell_u\right)$ in the limit as $p$ tends to zero.

**Contribution from $ \alpha_u $.**  
We now proceed to prove approximate dual feasibility using the above characterization. First, consider the contribution from the offline vertex $u$.

_For any thresholds $ \theta\_{-u} $ of offline vertices other than $u$ and the corresponding $ \ell_u^{\infty} $:_

$$
\mathbb{E}_{\theta_u}\!\left[\alpha_u \mid \theta_{-u}\right]
\;\ge\;
\int_{0}^{\ell_u^{\infty}} e^{-\theta_u}\, f(\theta_u)\, d\theta_u \, .
$$

By the above characterization, $u$'s load equals $ \ell_u^{\infty} $ when $ \theta_u \ge \ell_u^{\infty} $, and equals $ \theta_u $ when $ 0 \le \theta_u < \ell_u^{\infty} $. Further, recall that $ \alpha_u = F(\ell_u) $ and that $ \theta_u \sim \operatorname{Exp}(1) $. We get that:

$$
\mathbb{E}_{\theta_u}\!\left[\alpha_u \mid \theta_{-u}\right]
\;\ge\;
\int_{0}^{\ell_u^{\infty}} e^{-\theta_u} F(\theta_u)\, d\theta_u
\;+\;
e^{-\ell_u^{\infty}} F(\ell_u^{\infty})
\;=\;
\int_{0}^{\ell_u^{\infty}} e^{-\theta_u} f(\theta_u)\, d\theta_u \, .
$$

Here, the equality follows by integration by parts. $\square$

---

**Contribution from $ \beta_v $’s.**  
Next, consider the contribution from the online vertices $ v \in S $. For ease of notations, we let $ z^{+} $ denote $ \max\{z,0\} $.

For any thresholds $ \theta\_{-u} $ of offline vertices other than $u$ and the corresponding $ \ell*u^{\infty} $:*

$$
\begin{aligned}
\mathbb{E}_{\theta_u}\!\left[\sum_{v\in S} \beta_v \,\middle|\, \theta_{-u}\right]
\;\ge\;
&\left(
e^{-\ell_u^{\infty}}\, p_u(S)
\;+\;
\int_{0}^{\ell_u^{\infty}} e^{-\theta_u}\, \big( p_u(S) - (\ell_u^{\infty}-\theta_u)^{+} \big)\, d\theta_u
\right) \\
&\times \big(1 - f(\ell_u^{\infty})\big)\, .
\end{aligned}
$$

_Proof._ By the above characterization, all vertices $ v \in S $ are matched to neighbors with load at most $ \ell_u^{\infty} $ at the time of the matches when $ \theta_u \ge \ell_u^{\infty} $. This happens with probability $ e^{-\ell_u^{\infty}} $ and contributes:

$$
e^{-\ell_u^{\infty}}\, p_u(S)\cdot \big(1 - f(\ell_u^{\infty})\big),
$$

to the expectation in the lemma.

Similarly, all vertices $ v \in S $, except for $ p^{-1}(\ell_u^{\infty}-\theta_u) $ of them, are still matched to neighbors with load at most $ \ell_u^{\infty} $ at the time of the matches when $ 0 \le \theta_u < \ell_u^{\infty} $.

> In the Stochastic Balance algorithm, each online vertex is matched to the unsuccessful neighbor with the least load, so only the overflow load $ \ell_u^{\infty}-\theta_u $ exceeds $ \theta_u $ and causes $ u $ to become successful.

This contributes:

$$
\int_{0}^{\ell_u^{\infty}} e^{-\theta_u}\, \big( p_u(S) - (\ell_u^{\infty}-\theta_u)^{+} \big)\, d\theta_u \cdot \big(1 - f(\ell_u^{\infty})\big),
$$

to the expectation. $\square$

So we have:

$$
\mathbf{E}\left[\alpha_u+\sum_{v \in S} \beta_v\right] \geq \int_0^{\ell_u^{\infty}} e^{-\theta_u} f\left(\theta_u\right) d \theta_u+\left(e^{-\ell_u^{\infty}} p_u(S)+\int_0^{\ell_u^{\infty}} e^{-\theta_u}\left(p_u(S)-\left(\ell_u^{\infty}-\theta_u\right)\right)^{+} d \theta_u\right)\left(1-\mathscr{f}\left(\ell_u^{\infty}\right)\right)
$$

To show approximate dual feasibility, it suffices to find a non-decreasing function $f$ such that for any $\ell_u^{\infty} \geq 0$ and any $0 \leq p_u(S) \leq 1$ :

$$
\int_0^{\ell_u^{\infty}} e^{-\theta_u} f\left(\theta_u\right) d \theta_u+\left(e^{-\ell_u^{\infty}} p_u(S)+\int_0^{\ell_u^{\infty}} e^{-\theta_u}\left(p_u(S)-\left(\ell_u^{\infty}-\theta_u\right)\right)^{+} d \theta_u\right)\left(1-f\left(\ell_u^{\infty}\right)\right) \geq \Gamma \cdot p_u(S)
$$

Therefore, there is at most one index $j$ such that $\ell_j<\ell_u^{\infty}$ and $\ell_{j+1} \geq \ell_u^{\infty}$.


### Solving the Differential Inequality

For ease of notations, we write $\ell_u^{\infty}$ as $\ell, p_u(S)$ as $p$, and $\theta_u$ as $\theta$. Then, =becomes:

$$
\int_0^{\ell} e^{-\theta} f(\theta) d \theta+\left(e^{-\ell} p+\int_0^{\ell} e^{-\theta}(p-(\ell-\theta))^{+} d \theta\right)(1-f(\ell)) \geq \Gamma \cdot p .
$$

First, note that the $z^{+}$operation effectively restricts the second integration in the above equation to be from max $\{0, \ell-p\}$ to $\ell$. This allows us to simplify the above equation by taking away the $z^{+}$operation. Concretely, it suffices to ensure that for any $0 \leq p<\ell$ :

$$
\int_0^{\ell} e^{-\theta} f(\theta) d \theta+(1-f(\ell))\left(e^{-\ell+p}-e^{-\ell}\right) \geq \Gamma \cdot p,
$$

and for any $0 \leq \ell \leq p$ :

$$
\int_0^{\ell} e^{-\theta} f(\theta) d \theta+(1-f(\ell))\left(1-\ell+p-e^{-\ell}\right) \geq \Gamma \cdot p .
$$
